---
title: "R Notebook"
output: html_notebook
---

```{r}
library(Seurat)
library(dittoSeq)
library(harmony)
library(SeuratWrappers)
library(scCustomize)
library(scds)
library(presto)
library(viridis)
library(stringr)
library(gpsFISH)
```

```{r}
options(future.globals.maxSize= 8912896000)

thal = readRDS("/media/chang/HDD-8/chang/aparna/thal.rds")

thal = SCTransform(thal, vst.flavor='v2', assay = "cleaned")

saveRDS(thal,"/media/chang/HDD-8/chang/aparna/thal.rds")

VariableFeatures(thal)[grepl("MT-", VariableFeatures(tha))]


thal = RunPCA(thal)
thal = RunHarmony(thal, group.by.vars = 'Sample', plot_convergence = T)
thal = RunUMAP(thal, dims=1:50, reduction = 'harmony')
thal = FindNeighbors(thal, dims=1:50, reduction = 'harmony')
thal = FindClusters(thal, resolution = .6, algorithm = 2)

thal$SubArea = "Thalamus"
thal$SubArea[grepl("dorsal",thal$orig.ident)] = "Dorsal"
thal$SubArea[grepl("ventral",thal$orig.ident)] = "Ventral"
thal$SubArea[grepl("caudal",thal$orig.ident)] = "Caudal"

thal$Sex = "M"
thal$Sex[thal$Sample == "CS19"] = "F"
thal$Sex[thal$Sample == "CS22_3"] = "F"
thal$Sex[thal$Sample == "GW14_Aparna"] = "F"
thal$Sex[thal$Sample == "GW22T"] = "F"

saveRDS(thal, file="/media/chang/HDD-9/chang/thal_gps.rds")

markers = wilcoxauc(thal2,seurat_assay = 'SCT')
top_markers(markers)

Idents(thal) = thal$SCT_snn_res.0.6
area = FindMarkers(thal, subset.ident = 4, group.by = 'SubArea',ident.1 = 'Ventral',ident.2 = 'Dorsal')
head(area[order(area$avg_log2FC, decreasing = T),], 20)
area_genes = c("FTH1","S100A6","LSAMP","PCDH9","SNTG1",
               "ROBO2","NEFL","RBP1","PENK","CALB1","CDH9","CD247")

area2 = FindMarkers(thal, subset.ident = 6, group.by = 'SubArea',ident.1 = 'Ventral',ident.2 = 'Dorsal')
head(area2[order(area2$avg_log2FC, decreasing = T),], 20)
area_genes2 = c("PKIB","TAC1")

area3 = FindMarkers(thal, ident.1 = '30', only.pos = T,min.diff.pct = .25)
head(area3[order(area3$avg_log2FC, decreasing = T),], 20)
area_genes3 = c("CALB2", "TCF7L2")

crabp1 = FindMarkers(thal, ident.1 = '32', only.pos = T,min.diff.pct = .25)
head(crabp1[order(crabp1$avg_log2FC, decreasing = T),], 20)
crabp1_genes = c("CRABP1","ST18","TAC3")

epend_genes = c("RSPH1","FOXJ1","GFAP","CRYAB")

genes = c(area_genes, area_genes2, area_genes3, crabp1_genes, epend_genes,
          "MRC1","AIF1","P2RY12","CLDN5","DCN","DLC1","MKI67","SOX6","PTPRZ1",
          "AQP4","SOX4","VIM","SST",'TXN')
```

```{r}
thal = readRDS("/media/chang/HDD-8/chang/aparna/thal.rds")
first = subset(thal, subset=Sample %in% c("CS12","CS14","CS15","CS19","CS22","CS22_2"))
first = SCTransform(first, vst.flavor='v2', assay='cleaned', variable.features.n = 2000)

VariableFeatures(first) = VariableFeatures(first)[!grepl("MT-", VariableFeatures(first))]
VariableFeatures(first) = VariableFeatures(first)[!grepl("MALAT1", VariableFeatures(first))]
VariableFeatures(first) = VariableFeatures(first)[!grepl("RPS", VariableFeatures(first))]
VariableFeatures(first) = VariableFeatures(first)[!grepl("RPL", VariableFeatures(first))]

VariableFeaturePlot_scCustom(first, num_features = 2000) & ylim(0,3)

first = RunPCA(first, npcs=20)
first = RunHarmony(first, group.by.vars='Sample', assay.use = "SCT")
first = RunUMAP(first, dims=1:20, reduction='harmony')
first = FindNeighbors(first, dims=1:20, reduction='harmony')

first = FindClusters(first, algorithm = 2, resolution = .5)

test = wilcoxauc(first, seurat_assay = 'SCT')

saveRDS(first, file='/media/chang/HDD-8/chang/aparna/first.rds')

DimPlot_scCustom(first, group.by = 'Sample')
DimPlot_scCustom(first, label=T)

do_BoxPlot(sample = first, feature = "nCount_RNA") + ylim(500,10000)

FeaturePlot(first, features = c("TCF7L2","MKI67","MEIS2","GAD2"), order=T,max.cutoff='q98') & NoAxes() & scale_color_viridis()


```

```{r}
first <- SetupForWGCNA(
  first,
  gene_select = "fraction", # the gene selection approach
  fraction = 0.01, # fraction of cells that a gene needs to be expressed in order to be included
  wgcna_name = "cleaned" # the name of the hdWGCNA experiment
)

first <- MetacellsByGroups(
  seurat_obj = first,reduction = 'harmony', target_metacells=2000,
  group.by = c("SCT_snn_res.0.5"), # specify the columns in seurat_obj@meta.data to group by
  k = 25,
  max_shared = 10, # maximum number of shared cells between two metacells
  ident.group = 'SCT_snn_res.0.5' # set the Idents of the metacell seurat object
)

first <- NormalizeMetacells(first)

GetMetacellObject(first)@assays$cleaned@data


first <- SetDatExpr(
  first,
  group_name = "SCT_snn_res.0.5", # the name of the group of interest in the group.by column
  group.by='SCT_snn_res.0.5', # the metadata column containing the cell type info. This same column should have also been used in MetacellsByGroups
  assay = 'cleaned', # using RNA assay
  slot = 'data' # using normalized data
)

first <- TestSoftPowers(
  first,
  networkType = 'signed' # you can also use "unsigned" or "signed hybrid"
)

# plot the results:
plot_list <- PlotSoftPowers(first)

# assemble with patchwork
wrap_plots(plot_list, ncol=2)

first <- ConstructNetwork(
  first, soft_power=9,
  setDatExpr=FALSE,
  tom_name = 'INH' # name of the topoligical overlap matrix written to disk
)
```

```{r}
gw19 = LoadVizgen("/media/chang/HDD-8/chang/aparna/vizgen/Processed/202210191506_gw23THAL061920CASEDSNOW_VMSC01801/region_0/")

gw23 = LoadVizgen("/media/chang/HDD-8/chang/aparna/vizgen/Processed/202210191506_gw23THAL061920CASEDSNOW_VMSC01801/region_0/")
```

```{r}
X_center <- rowMeans(thal@assays$RNA@data[VariableFeatures(thal),])
X_scale <- proxyC::rowSds(thal@assays$RNA@data[VariableFeatures(thal),])
retval <- irlba::irlba(A = t(thal@assays$RNA@data[VariableFeatures(thal),]), 
                       nv = 50, center = X_center, scale = X_scale)
retval$x <- retval$u %*% diag(retval$d)
merged[['pca']] = CreateDimReducObject(retval$x, key='pca_')
rownames(merged[["pca"]]@cell.embeddings) <- Cells(merged)
```

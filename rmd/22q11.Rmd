---
title: "22q11"
output: html_notebook
---


```{r}
library(Seurat)
library(dittoSeq)
library(harmony)
library(SeuratWrappers)
library(scCustomize)
library(presto)
library(viridis)
library(stringr)
library(FastCAR)
library(Matrix)
library(DropletQC)
library(SingleCellExperiment)
library(lemur)

ReadSTAR <- function(data.dir, vireo,  proj = "SeuratObject", feats = 1000, 
                     ratio=.1, counts = 1000, sample="Sample") {
  data.dir.genefull = paste0(data.dir, "GeneFull_Ex50pAS/raw")
  mtx = file.path(data.dir.genefull, "UniqueAndMult-EM.mtx")
  cells = file.path(data.dir.genefull, "barcodes.tsv")
  features = file.path(data.dir.genefull, "features.tsv")
  raw = ReadMtx(mtx = mtx, cells = cells, features = features)
  
  seurat = CreateSeuratObject(raw, project=proj, min.features = feats)
  
  data.dir.velo = paste0(data.dir, "/Velocyto/raw")
  cells = file.path(data.dir.velo, "barcodes.tsv")
  features = file.path(data.dir.velo, "features.tsv")
  spliced = file.path(data.dir.velo, "spliced.mtx")
  unspliced = file.path(data.dir.velo, "unspliced.mtx")
  ambi = file.path(data.dir.velo, "ambiguous.mtx")
  spliced = ReadMtx(mtx = spliced, cells = cells, features = features)
  unspliced = ReadMtx(mtx = unspliced, cells = cells, features = features)
  ambi = ReadMtx(mtx = ambi, cells = cells, features = features)
  spliced = spliced + ambi

  seurat[['unspliced']] = CreateAssayObject(unspliced[,colnames(seurat)])
  seurat[['spliced']] = CreateAssayObject(spliced[,colnames(seurat)])
  seurat$Sample = sample
  
  vir = read.table(paste0(vireo, "donor_ids.tsv"), sep='\t', 
                     header=T, row.names = 1)
  cbc = intersect(rownames(vir), colnames(seurat))
  seurat = subset(seurat, cells=cbc)
  vir = vir[cbc,]
  seurat@meta.data = cbind(seurat@meta.data, vir)
  seurat = subset(seurat, subset=donor_id != "unassigned")

  ambProfile = describe.ambient.RNA.sequence(fullMatrix = raw, 
                                             start = 10, 
                                             stop = 200, 
                                             by = 10, 
                                             contaminationChanceCutoff = 0.05)
  emptyDropletCutoff = recommend.empty.cutoff(ambProfile)
  ambientProfile = determine.background.to.remove(raw, emptyDropletCutoff, .05)
  seurat[['cleaned']] = CreateAssayObject(remove.background(seurat@assays$RNA@counts, ambientProfile))
  seurat[['percent.mt']] = PercentageFeatureSet(seurat, pattern = "MT-",assay = 'cleaned')
  seurat = subset(seurat, subset=donor_id != "doublet" & percent.mt <= 20)

  return(seurat)
}

org = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org/org_cr/outs/org_Solo.out/",
               "/media/chang/HDD-3/chang/david/DS_org/org_cr/outs/vireo/", 
               proj = "org")

org$donor_id[org$donor_id == "donor0"] = "540135"
org$donor_id[org$donor_id == "donor1"] = "6OC2"
org$donor_id[org$donor_id == "donor2"] = "13234"

org1 = ReadSTAR("/media/chang/HDD-3/chang/david/org_1_2/org_1/outs/DS_org_1_Solo.out/",              "/media/chang/HDD-3/chang/david/org_1_2/org_1/outs/vireo/",
                proj = 'org1')

org1$donor_id[org1$donor_id == "donor0"] = "35773"
org1$donor_id[org1$donor_id == "donor1"] = "28126"
org1$donor_id[org1$donor_id == "donor2"] = "28115"
org1$donor_id[org1$donor_id == "donor3"] = "540135"

org2 = ReadSTAR("/media/chang/HDD-3/chang/david/org_1_2/org_2/outs/DS_org_2_Solo.out/",              "/media/chang/HDD-3/chang/david/org_1_2/org_2/outs/vireo/",
                proj = 'org2')

org2$donor_id[org2$donor_id == "donor0"] = "35773"
org2$donor_id[org2$donor_id == "donor1"] = "28115"
org2$donor_id[org2$donor_id == "donor2"] = "540135"
org2$donor_id[org2$donor_id == "donor3"] = "28126"

org3 = ReadSTAR("/media/chang/HDD-3/chang/david/org3/org3_Solo.out/",              "/media/chang/HDD-3/chang/david/org3/vireo_5/", proj = 'org3')

org3$donor_id[org3$donor_id == "donor0"] = "35773"
org3$donor_id[org3$donor_id == "donor1"] = "540135"
org3$donor_id[org3$donor_id == "donor2"] = "13234"
org3$donor_id[org3$donor_id == "donor3"] = "6OC2"
org3$donor_id[org3$donor_id == "donor4"] = "28126"

org_apr = ReadSTAR("/media/chang/HDD-3/chang/david/DSTJN01_10XThalOrgWK10_Apr2021/ThalOrgWk10_Apr2021_Solo.out/", "/media/chang/HDD-3/chang/david/DSTJN01_10XThalOrgWK10_Apr2021/vireo/", proj = 'org_apr')

org_apr$donor_id[org_apr$donor_id == "donor0"] = "WTC11"
org_apr$donor_id[org_apr$donor_id == "donor1"] = "28126"
org_apr$donor_id[org_apr$donor_id == "donor2"] = "6OC2"

ab2 = ReadSTAR("/media/chang/HDD-3/chang/david/latest_org/DSTJN01/ThalOrgWithAB2/ThalOrgWithAB2_Solo.out/","/media/chang/HDD-3/chang/david/latest_org/DSTJN01/ThalOrgWithAB2/vireo/", proj='ThalOrgWithAB2')

ab2$donor_id[ab2$donor_id == "donor0"] = "X"
ab2$donor_id[ab2$donor_id == "donor1"] = "AB2"
ab2$donor_id[ab2$donor_id == "donor2"] = "540135"
ab2$donor_id[ab2$donor_id == "donor3"] = "Y"
ab2$donor_id[ab2$donor_id == "donor4"] = "35773"
ab2$donor_id[ab2$donor_id == "donor5"] = "Z"
ab2$donor_id[ab2$donor_id == "donor6"] = "6OC2"
ab2$donor_id[ab2$donor_id == "donor7"] = "13234"

wtc10 = ReadSTAR("/media/chang/HDD-3/chang/david/latest_org/DSTJN01/ThalOrgWithWTC10/ThalOrgWithWTC10_Solo.out/","/media/chang/HDD-3/chang/david/latest_org/DSTJN01/ThalOrgWithWTC10/vireo/", proj='ThalOrgWithWTC10')

wtc10$donor_id[wtc10$donor_id == "donor0"] = "540135"
wtc10$donor_id[wtc10$donor_id == "donor1"] = "35773"
wtc10$donor_id[wtc10$donor_id == "donor2"] = "Y"
wtc10$donor_id[wtc10$donor_id == "donor3"] = "X"
wtc10$donor_id[wtc10$donor_id == "donor4"] = "Z"
wtc10$donor_id[wtc10$donor_id == "donor5"] = "6OC2"
wtc10$donor_id[wtc10$donor_id == "donor6"] = "13234"

wtc11 = ReadSTAR("/media/chang/HDD-3/chang/david/latest_org/DSTJN01/ThalOrgWithWTC11/ThalOrgWithWTC11_Solo.out/","/media/chang/HDD-3/chang/david/latest_org/DSTJN01/ThalOrgWithWTC11/vireo/", proj='ThalOrgWithWTC11')

wtc11$donor_id[wtc11$donor_id == "donor0"] = "6OC2"
wtc11$donor_id[wtc11$donor_id == "donor1"] = "540135"
wtc11$donor_id[wtc11$donor_id == "donor2"] = "WTC11"
wtc11$donor_id[wtc11$donor_id == "donor3"] = "X"
wtc11$donor_id[wtc11$donor_id == "donor4"] = "Y"
wtc11$donor_id[wtc11$donor_id == "donor5"] = "13234"
wtc11$donor_id[wtc11$donor_id == "donor6"] = "35773"
wtc11$donor_id[wtc11$donor_id == "donor7"] = "Z"

lane1 = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane1/DS_Lane1_Solo.out/", "/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane1/vireo/", proj="Lane1")

lane1$donor_id[lane1$donor_id == "donor0"] = "28126"
lane1$donor_id[lane1$donor_id == "donor1"] = "13234"
lane1$donor_id[lane1$donor_id == "donor2"] = "35773"
lane1$donor_id[lane1$donor_id == "donor3"] = "6OC2"

lane2 = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane2/DS_Lane2_Solo.out/", "/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane2/vireo/", proj="Lane2")

lane2$donor_id[lane2$donor_id == "donor0"] = "28126"
lane2$donor_id[lane2$donor_id == "donor1"] = "6OC2"
lane2$donor_id[lane2$donor_id == "donor2"] = "35773"
lane2$donor_id[lane2$donor_id == "donor3"] = "13234"

lane3 = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane3/DS_Lane3_Solo.out/", "/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane3/vireo/", proj="Lane3")

lane3$donor_id[lane3$donor_id == "donor0"] = "13234"
lane3$donor_id[lane3$donor_id == "donor1"] = "28126"
lane3$donor_id[lane3$donor_id == "donor2"] = "35773"
lane3$donor_id[lane3$donor_id == "donor3"] = "6OC2"

lane4 = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane4/DS_Lane4_Solo.out/", "/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane4/vireo/", proj="Lane4")

lane4$donor_id[lane4$donor_id == "donor0"] = "540135"
lane4$donor_id[lane4$donor_id == "donor1"] = "13234"
lane4$donor_id[lane4$donor_id == "donor2"] = "6OC2"
lane4$donor_id[lane4$donor_id == "donor3"] = "28126"
lane4$donor_id[lane4$donor_id == "donor4"] = "35773"

lane5 = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane5/DS_Lane5_Solo.out/", "/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane5/vireo/", proj="Lane5")

lane5$donor_id[lane5$donor_id == "donor0"] = "28126"
lane5$donor_id[lane5$donor_id == "donor1"] = "540135"
lane5$donor_id[lane5$donor_id == "donor2"] = "6OC2"
lane5$donor_id[lane5$donor_id == "donor3"] = "35773"
lane5$donor_id[lane5$donor_id == "donor4"] = "13234"

lane6 = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane6/DS_Lane6_Solo.out/", "/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane6/vireo/", proj="Lane6")

lane6$donor_id[lane6$donor_id == "donor0"] = "6OC2"
lane6$donor_id[lane6$donor_id == "donor1"] = "28126"
lane6$donor_id[lane6$donor_id == "donor2"] = "13234"
lane6$donor_id[lane6$donor_id == "donor3"] = "540135"
lane6$donor_id[lane6$donor_id == "donor4"] = "35773"

lane7 = ReadSTAR("/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane7/DS_Lane7_Solo.out/", "/media/chang/HDD-3/chang/david/DS_org_fastq/DS_Lane7/vireo/", proj="Lane7")

lane7$donor_id[lane7$donor_id == "donor0"] = "6OC2"
lane7$donor_id[lane7$donor_id == "donor1"] = "540135"
lane7$donor_id[lane7$donor_id == "donor2"] = "28126"
lane7$donor_id[lane7$donor_id == "donor3"] = "13234"
lane7$donor_id[lane7$donor_id == "donor4"] = "35773"

org_list = list(org, org_apr, org1, org2, org3, ab2, wtc10, wtc11, lane1, lane2,
                lane3, lane4, lane5, lane6, lane7)

saveRDS(org_list, file='/media/chang/HDD-3/chang/david/org.list.rds')

merged = merge(org_list[[1]], org_list[2:length(org_list)])

saveRDS(merged, file='/media/chang/HDD-3/chang/david/merged.rds')
```

```{r}
merged = readRDS("/media/chang/HDD-3/chang/david/merged.rds")

merged = SCTransform(merged, vst.flavor='v2', assay = "cleaned")
VariableFeatures(merged) = VariableFeatures(merged)[!grepl("MT-", VariableFeatures(merged))]
VariableFeatures(merged) = VariableFeatures(merged)[!grepl("MALAT1", VariableFeatures(merged))]
VariableFeatures(merged) = VariableFeatures(merged)[!grepl("RPS", VariableFeatures(merged))]
VariableFeatures(merged) = VariableFeatures(merged)[!grepl("RPL", VariableFeatures(merged))]

merged = RunPCA(merged, npcs = 30)
merged = RunUMAP(merged, dims=1:30)

merged$Batch = merged$orig.ident
merged$Batch[grepl("Thal", merged$Batch)] = "Thal"
merged$Batch[grepl("org_apr", merged$Batch)] = "org_apr"
merged$Batch[grepl("org1", merged$Batch)] = "org1_2"
merged$Batch[grepl("org2", merged$Batch)] = "org1_2"
merged$Batch[grepl("org3", merged$Batch)] = "org3"
merged$Batch[grepl("org_cr", merged$Batch)] = "org_cr"
merged$Batch[grepl("Lane1", merged$Batch)] = "Lane1_3"
merged$Batch[grepl("Lane2", merged$Batch)] = "Lane1_3"
merged$Batch[grepl("Lane3", merged$Batch)] = "Lane1_3"
merged$Batch[grepl("Lane4", merged$Batch)] = "Lane4_7"
merged$Batch[grepl("Lane5", merged$Batch)] = "Lane4_7"
merged$Batch[grepl("Lane6", merged$Batch)] = "Lane4_7"
merged$Batch[grepl("Lane7", merged$Batch)] = "Lane4_7"
merged$Batch[merged$Batch == "org"] = "org"

merged$Condition = "CTRL"
merged$Condition[grepl("6OC2", merged$donor_id)] = "22Q"
merged$Condition[grepl("540135", merged$donor_id)] = "22Q"
merged$Condition[grepl("35773", merged$donor_id)] = "22Q"
merged$Condition[grepl("AB2", merged$donor_id)] = "22Q"

merged$Condition[grepl("X", merged$donor_id)] = "UNK"
merged$Condition[grepl("Y", merged$donor_id)] = "UNK"
merged$Condition[grepl("Z", merged$donor_id)] = "UNK"


merged = RunHarmony(merged, group.by.vars = "Batch", kmeans_init_nstart=20,
                    kmeans_init_iter_max=100, assay.use = "SCT",plot_convergence = T)
merged = RunUMAP(merged, dims=1:30, reduction = 'harmony')
merged = FindNeighbors(merged, dims=1:30, reduction = 'harmony')
merged = FindClusters(merged, algorithm=2, resolution=.1)

saveRDS(merged, file='/media/chang/HDD-3/chang/david/merged_proc.rds')

DimPlot(merged, group.by = c("donor_id",'orig.ident','Batch',"Condition"), 
        cols = dittoColors()) & NoAxes()

FeaturePlot(merged ,features = c("FOXG1","TCF7L2","SOX2","POU4F1","GBX2",
                                 "DLX2","FOXP2","EN1","LHX1"),
            ncol = 3, order=T, max.cutoff = 'q99') & NoAxes()
```

```{r}
sce = as.SingleCellExperiment(merged, assay = 'SCT')
fit <- lemur(sce, design = ~ donor_id + Condition, n_embedding = 20, verbose = FALSE)

# We can regularize the alignment either using ridge regression
# or by allowing only rotations or stretching
fit <- align_harmony(fit, stretching = FALSE)



```
